<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quiz Biblico</title>
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="style.css">
</head>
<style>
body {
  background: url('img/quiz-background.jpg') no-repeat center center fixed;
  background-size: cover;
}

</style>

<body>
  <div class="container">
    <h1 class="text-center m-4">üß© Quiz Biblico</h1>
    <div class="question-box" id="quizBox">
      <h4 class="text-center" id="question"></h4>
      <div id="options" class="mt-3"></div>
      <div id="feedback" class="text-center"></div>
      <div class="text-center mt-4">
        <button id="nextBtn" class="btn btn-primary btn-lg px-5 py-2 shadow-sm rounded-pill" disabled>Prossima</button>
      </div>
    </div>
    <div id="result" class="text-center mt-4"></div>

    <div class=" mt-4">
       <a href="index.html" class="btn btn-secondary rounded-pill px-4">‚åÇ Torna alla Home</a>
    </div>

  </div>

  <script>
    let questions = [];

    fetch(`data/quiz.json?ts=${Date.now()}`)
      .then(res => res.json())
      .then(data => {
        allQuestions = shuffleArray(data);
        // mostra il modal
        document.getElementById('maxBtn').textContent = `Tutte (${allQuestions.length})`;
        const modal = new bootstrap.Modal(document.getElementById('questionCountModal'));
        modal.show();
      })
      .catch(err => {
        console.error("Errore nel caricamento delle domande:", err);
        document.getElementById("quizBox").innerHTML = "<p class='text-danger'>Errore nel caricamento delle domande.</p>";
      });

    function shuffleArray(array) {
      // Algoritmo Fisher-Yates
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    let current = 0;
    let score = 0;
    let errori = [];
    let allQuestions = [];

    let questionEl = document.getElementById("question");
    let optionsEl = document.getElementById("options");
    let nextBtn = document.getElementById("nextBtn");
    let resultEl = document.getElementById("result");
    let quizBox = document.getElementById("quizBox");
    let feedbackEl = document.getElementById("feedback");

    function loadQuestion() {
      nextBtn.disabled = true;
      feedbackEl.textContent = "";
      const q = questions[current];
      questionEl.textContent = q.domanda;
      optionsEl.innerHTML = "";
      shuffleArray([...q.risposte]).forEach(risposta => {
        const btn = document.createElement("button");
        btn.textContent = risposta;
        btn.className = "btn btn-outline-secondary option rounded-pill w-100";
        btn.onclick = () => selectAnswer(btn, q);
        optionsEl.appendChild(btn);
      });
    }

    function selectAnswer(button, q) {
      [...optionsEl.children].forEach(btn => btn.disabled = true);
      button.classList.remove("btn-outline-secondary");
      if (button.textContent === q.corretta) {
        button.classList.add("btn-success");
        button.classList.add("fw-semibold");
        score++;
        feedbackEl.innerHTML = `‚úÖ Corretto! ${q.riferimento ? `<br><small class="text-muted">üìñ ${q.riferimento}</small>` : ''}`;
        feedbackEl.classList.remove("text-danger");
        feedbackEl.classList.add("text-success");
      } else {
        button.classList.add("btn-danger");
        feedbackEl.innerHTML = `‚ùå Sbagliato! La risposta corretta √®: <strong>${q.corretta}</strong>${q.riferimento ? `<br><small class="text-muted">üìñ ${q.riferimento}</small>` : ''}`;
        feedbackEl.classList.remove("text-success");
        feedbackEl.classList.add("text-danger");
        errori.push(q);
      }
      nextBtn.disabled = false;
      nextBtn.focus();

    }

    nextBtn.onclick = () => {
      current++;
      if (current < questions.length) {
        loadQuestion();
      } else {
        quizBox.innerHTML = "";

        let html = `
           <div class="card border-0 shadow-sm p-4 text-center bg-white rounded-4">
            <h3 class="text-success mb-3">
              <i class="bi bi-check-circle-fill me-2"></i>Hai completato il quiz!
            </h3>
            <p class="fs-5">
              <span class="text-muted">Risposte corrette:</span>
              <span class="badge rounded-pill bg-success fs-5 px-3 py-2">${score}</span>
              <span class="text-muted">su</span>
              <span class="badge rounded-pill bg-secondary fs-5 px-3 py-2">${questions.length}</span>
            </p>
          </div>
    `;

        if (errori.length > 0) {
          html += `
           <div class="d-flex justify-content-center mt-4">
            <button id="retryBtn" class="btn btn-warning btn-lg d-flex align-items-center gap-2 px-4 shadow-sm rounded-pill">
              <i class="bi bi-arrow-repeat"></i>
              Ripeti solo gli errori
              <span class="badge rounded-pill bg-danger text-white">${errori.length}</span>
            </button>
          </div>

      `;
        }

        html += `</div>`;

        resultEl.innerHTML = html;
        localStorage.setItem('quizScore', score);

        const retryBtn = document.getElementById("retryBtn");
        if (retryBtn) {
          retryBtn.addEventListener("click", ripetiErrori);
        }
      }
    };


    function ripetiErrori() {
      if (errori.length === 0) return;
      questions.splice(0, questions.length, ...errori);
      current = 0;
      score = 0;
      errori = [];
      resultEl.innerHTML = "";
      quizBox.innerHTML = `
        <h4 id="question" class="text-center"></h4>
        <div id="options" class="text-center rounded-pill mt-3"></div>
        <div id="feedback" class="text-center"></div>
        <div class="d-grid gap-2">
      <button id="nextBtn" class="btn btn-primary btn-lg px-5 py-2 shadow-sm rounded-pill mt-3" disabled>Prossima</button>
    </div>
      `;
      questionEl = document.getElementById("question");
      optionsEl = document.getElementById("options");
      nextBtn = document.getElementById("nextBtn");
      feedbackEl = document.getElementById("feedback");
      nextBtn.onclick = () => {
        current++;
        if (current < questions.length) {
          loadQuestion();
        } else {
          quizBox.innerHTML = "";
          let html = `
          <div class="card border-0 shadow-sm p-4 text-center bg-white rounded-4">
            <h3 class="text-success mb-3">
              <i class="bi bi-check-circle-fill me-2"></i>Hai completato il quiz!
            </h3>
            <p class="fs-5">
              <span class="text-muted">Risposte corrette:</span>
              <span class="badge rounded-pill bg-success fs-5 px-3 py-2">${score}</span>
              <span class="text-muted">su</span>
              <span class="badge rounded-pill bg-secondary fs-5 px-3 py-2">${questions.length}</span>
            </p>
          </div>
          `;
          if (errori.length > 0) {
            html += `
          <div class="d-flex justify-content-center mt-4">
            <button id="retryBtn" class="btn btn-warning btn-lg d-flex align-items-center gap-2 px-4 shadow-sm rounded-pill">
              <i class="bi bi-arrow-repeat"></i>
              Ripeti solo gli errori
              <span class="badge rounded-pill bg-danger text-white">${errori.length}</span>
            </button>
          </div>
            `;
          }
          resultEl.innerHTML = html;
          localStorage.setItem('quizScore', score);

          const retryBtn = document.getElementById("retryBtn");
          if (retryBtn) {
            retryBtn.addEventListener("click", ripetiErrori);
          }
        }
      };
      loadQuestion();
    }

    function startQuiz(count) {
      questions = count === 'MAX' ? allQuestions : allQuestions.slice(0, count);
      current = 0;
      score = 0;
      errori = [];
      resultEl.innerHTML = "";
      quizBox.style.display = 'block';
      loadQuestion();

      // chiudi il modal
      const modalEl = document.getElementById('questionCountModal');
      const modal = bootstrap.Modal.getInstance(modalEl);
      modal.hide();
    }

  </script>


  <!-- Modal selezione domande -->
  <div class="modal fade" id="questionCountModal" tabindex="-1" aria-labelledby="questionCountLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center shadow rounded-4 border-0 p-4 bg-light-subtle custom-modal-bg">
        <div class="modal-header">
          <h4 class="modal-title w-100" id="questionCountLabel">Quante domande?</h4>
        </div>
        <div class="modal-body">
          <button class="btn btn-primary rounded-pill px-4 py-2 m-2" onclick="startQuiz(1)">1</button>
          <button class="btn btn-primary rounded-pill px-4 py-2 m-2" onclick="startQuiz(10)">10</button>
          <button class="btn btn-primary rounded-pill px-4 py-2 m-2" onclick="startQuiz(15)">15</button>
          <button class="btn btn-primary rounded-pill px-4 py-2 m-2" onclick="startQuiz(30)">30</button>
          <button class="btn btn-secondary rounded-pill px-4 py-2 m-2" id="maxBtn" onclick="startQuiz('MAX')">Tutte (?)</button>
        </div>
      </div>
    </div>
  </div>

</body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</html>